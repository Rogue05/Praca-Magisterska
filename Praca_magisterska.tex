\documentclass[10pt,a4paper]{article}
%\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{float}
\usepackage{tikz-cd}
\usepackage{mathtools}
\usepackage{enumitem}
%\renewcommand{\figurename}{Rysunek}

\usepackage{algorithm,algorithmic}

\usepackage{polski}
\usepackage[polish]{babel}
% dr ratajczak
% ziomek


\author{Wojciech Sopot 235291}
\title{Filtry cząsteczkowe i ich zastosowania w problemach wyznaczania lokalizacji}
\begin{document}
\maketitle
\tableofcontents
\newpage
\section{Wprowadzenie}W rozdziale przedstawiono cel i zakres pracy oraz podstawowe zadania i problemy wyznaczania lokalizacji. Ponadto opisano ogólną ideę stojącą za filtrami cząsteczkowymi - filtrację bayesowską. 
\subsection{Zadania i problemy wyznaczania lokalizacji}
Mogłoby się wydawać, iż w dzisiejszych, gdy mamy możliwość korzystania z systemu GPS, nie ma potrzeby zajmować się innymi sposobami wyznaczania lokalizacji. Jednak o ile jest to prawdą w dużej skali, jak np. gdy chce się wyznaczyć adres w mieście pod którym się znajdujemy, to gdy chcemy wyznaczyć swoją lokalizację bardziej dokładnie, np. jak to robią niektóre odkurzacze mobilne, to trzeba wykorzystać do tego dane z innych sensorów, np. lidarów. Czasami można wcale nie mieć możliwości korzystania z systemu GPS, na przykład pod wodą. Innym problemem może być poprawa już znanego przybliżonego położenia. W pracy zostaną przeanalizowane dwa problemy związane z wyznaczaniem lokalizacji:
\begin{itemize}
	\item Określanie położenia samolotu, na podstawie znanej mapy wysokościowej terenu, odczytów z wysokościomierza barometrycznego, oraz, ewentualnie, dodatkowych danych (np. odczytu z kompasu). 
	\item Określanie lokalizacji robota mobilnego, umieszczonego w ograniczonej przestrzeni z przeszkodami (ale na płaskiej powierzchni - mapa jest w dwóch wymiarach).
\end{itemize}
Mimo tego, iż są to jedynie dwa przypadki, w praktyce można je uogólnić na wile przypadków. Dla przykładu w \cite{underwater_pf} zajęto się problemem lokalizacji pod wodą, który w praktyce można rozwiązać w ten sam sposób co problem samolotu - mapa wysokości zostaje jedynie zastąpiona przez mapę głębokości.
\subsection{Cel pracy}
Celem pracy jest rozpoznanie możliwości zastosowania filtrów cząsteczkowych do rozwiązywania problemu lokalizacji oraz samodzielne zaimplementowanie i przebadanie kilku, uznanych arbitralnie przez autora za najciekawsze.
\subsection{Zakres pracy}
W zakres pracy wchodzi przegląd literatury na temat filtrów cząsteczkowych pod kątem problemów wyznaczania lokalizacji, następnie wybranie kilku rozwiązań oraz ich przebadanie. Aby było to możliwe konieczny jest także przegląd znanych narzędzi programistycznych, które mogą być zastosowane do zaimplementowania algorytmów.

\subsection{Idea filtracji Bayesowskiej}
Na chwilę obecną, algorytmy oparte o filtrację Bayesowską są szeroko wykorzystywane w automatyce i robotyce. W skrócie, podejście to polega na przeprowadzaniu cykli predykcji i poprawek, na podstawie rozkładu a priori oraz zbieranych w kolejnych iteracjach pomiarów, w celu wyznaczenia rozkładu a posteriori stanu. Ideę tego podejścia widać na rysunku \ref{bayes_fil_idea}. 
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=10cm]{./predict_update.png}
		\caption{Idea filtracji Bayesowskiej. Obrazek zaczerpnięto z https://www.codeproject.com/Articles/865934/Object-Tracking-Particle-Filter-with-Ease}
		\label{bayes_fil_idea}
	\end{center}
\end{figure}
Na rysunku \ref{filtr_hier} przedstawiono hierarchię rozwiązać opartych o to podejście. Jak widać jest to bardzo duża rodzina rozwiązań, znajdujący  W pracy zostaną poruszone metody oparte o filtry cząsteczkowe.
\begin{figure}
	\begin{center}
		\includegraphics[width=10cm]{./nfg001.jpg}
		\caption{Hierarchia filtrów opartych o filtrację Bayesowską. Obrazek zaczerpnięto z \cite{prac_gui}}
		\label{filtr_hier}
	\end{center}
\end{figure}
\section{Filtry cząsteczkowe}
%\subsection{Pojęcia podstawowe}
\subsection{Opis problemu}
Celem filtru cząsteczkowego jest wyznaczenie rozkładu zmiennej stanu $X_k$, na podstawie szczątkowych pomiarów $Y_k$ za pomocą filtracji Bayesowskiej. \\
\begin{equation*}
\begin{tikzcd}
	X_0 \arrow{r} \arrow{d} &X_1 \arrow{r} \arrow{d} &X_2 \arrow{r} \arrow{d} &X_3\arrow{r} \arrow{d} &...\\
	Y_0 &Y_1 &Y_2 &Y_3 &...
\end{tikzcd} 
\end{equation*}
System taki, można opisać w następujący sposób
\begin{equation*}
	\begin{aligned}
		X_k=g(X_{k-1})+W_{k-1} \\
		Y_k=h(X_k)+V_k
	\end{aligned}
\end{equation*}
gdzie $g$ i $h$ to znane funkcje, a $W_{k-1}$ i $V_k$ to szumy. Jeśli oba szumy byłyby z rozkładu normalnego, a $g$ i $h$ są liniowe, to problem można rozwiązać za pomocą filtru Kalmana. Aby zyskać na ogólności, system można opisać w następujący sposób:
\begin{equation}
	\begin{aligned}
		X_k=g(X_{k-1}, W_{k-1}) \\
		Y_k=h(X_k, V_k)
	\end{aligned}
\end{equation}
Taki problem, gdy funkcje $g$ i $h$ mogą być nieliniowe względem $X_k$, $Y_k$ oraz szumów $W_{k-1}$ i $V_k$, zazwyczaj jest zbyt złożony aby można było zastosować podejścia oparte o filtr kalmana. W takich przypadkach jedną z możliwości jest zastosowanie filtrów cząsteczkowych.
\subsection{Matematyczny opis filtracji Bayesowskiej}
Ogólne wzory na filtrowanie Bayesowskie można znaleźć na przykład na wikipedi \cite{wiki_bayes_filter}. Celem pojedynczego kroku filtracji jest wyznaczenie rozkładu a posteriori $p(X_{k}|Y_{0...k})$ opisującego prawdopodobieństwo, że system jest w stanie $X_k$, przy założeniu historii pomiarów $Y_{0...k}$, na podstawie rozkładu a priori $p(X_{k-1}|Y_{0...k-1})$ uzyskanego w poprzednim kroku. Etap predykcji można opisać poniższym równaniem:
\begin{equation} \label{evolution}
	p(X_k|Y_{0...k-1})=\int p(X_k|X_{k-1})p(X_{k-1}|Y_{0...k-1}) dX_{k-1}
\end{equation}
gdzie $p(X_k|X_{k-1})$ opisuje ewolucję systemu między krokami $k-1$ i $k$. Etap korekcji realizuje się w oparciu o wzór Bayesa, po otrzymaniu kolejnego pomiaru $Y_k$:
\begin{equation}\label{bayes_formula}
	p(X_k|Y_{0...k})=\frac{p(Y_k|X_k)p(X_k|Y_{0...k-1})}{p(Y_k|Y_{0...k-1})}
\end{equation}
gdzie $p(Y_k|X_k)$ opisuje rozkład prawdopodobieństwa uzyskania pomiaru $Y_k$ w stanie $X_k$. Warto zauważyć, iż $p(Y_k|Y_{0...k})$ można opisać wzorem:
\begin{equation}
p(Y_k|Y_{0...k})=\int p(Y_k|X_k)p(X_k|Y_{0...k-1}) dX_k
\end{equation}
więc mianownik równania \ref{bayes_formula} jest stały względem $X_k$. Mając to na uwadze, oraz podstawiając równanie \ref{evolution} do \ref{bayes_formula} można uzyskać ogólną formułę jednego kroku filtracji:
\begin{equation}
	p(X_k|Y_{0...k})=\mu p(Y_k|X_k)\int p(X_k|X_{k-1})p(X_{t-1}|Y_{0...t-1}) dX_{t-1}
\end{equation}
gdzie $\mu$ jest stałą normalizacyjną, pozostałą po przyjęciu że $p(Y_k|Y_{0...k})$ ma stałą wartość.
\subsection{Importance sampling i regularyzacja}
Równanie (5) stanowi podstawę konstrukcji wielu algorytmów....\\
Istotna trudność w jego zastosowaniu polega jednak na tym, 

Aby móc w praktyce zrealizować równanie (5), trzeba skorzystać z dwóch konceptów - importance samplingu(IS) i regularyzacji. \\
Nie wiem czy jest sens to opisywać, bo koniec końców to się sprowadza do opisu algorytmu w kolejnym rozdziale
\subsection{Podstawowy algorytm filtra cząsteczkowego}
W filtrze cząsteczkowym, ciągłe rozkłady $p(\bullet)$ są symulowane za pomocą chmury ważonych cząstek. Każda cząstka wygląda w następujący sposób:
\begin{equation*}
	p_i=\{x_{k,i},w_{k,i}\}
\end{equation*}
Gdzie $x_{k,i}$ to stan w iteracji $k$ związany z cząstką $i$, $w_{k,i}$ to jej waga.
Początkowo całą populację cząstek inicjuje się cząstkami z losowymi stanami i wagami, równymi dla każdej cząstki. Następnie wykonuje się w pętli:
\begin{enumerate}[label=(\alph*)]
	\item Wyznacza się nowy zbiór cząstek, dla każdej cząstki $x_{k,i}$ uzyskuje się, symulując jej ewolucję, w oparciu o $x_{k-1,i}$. Model ruchu powinien uwzględniać szumy obecne w systemie.
	\item Pojawia się nowy pomiar $Y_k$, na podstawie którego na którego podstawie modyfikuje się wagi poszczególnych cząstek.
	\item Wagi są normalizowane.
	\item Wyznacza się estymowany stan, wyznaczając ważoną średnią stanów wszystkich cząstek.
	\item Wyznacza się efektywną liczbę cząstek według wzoru:
	\begin{equation*}
		N_{eff_k} = \dfrac{1}{\sum w_{k,i}^2}
	\end{equation*}
	Jeśli jej wartość jest mniejsza, niż pewien próg, to przeprowadza się ponowne próbkowanie, generując nową populację cząstek (jest to sztuczka pozwalająca na ograniczenie liczby obliczeń, teoretycznie próbkowanie można przeprowadzać co iterację).
\end{enumerate}

\subsection{Przykład}


\subsection{Adaptacyjna liczba cząstek}
Oczywistym jest, że największy wpływ na złożoność obliczeniową filtra cząsteczkowego ma ilość cząstek. W \cite{adaptive} opisano algorytm który służy do dynamicznego zmieniania liczby cząstek. Polega on na zmodyfikowaniu kroku (e) podstawowego algorytmu, gdzie tuż przed próbkowaniem wyznacza się nową liczbę cząstek, korzystając z poniższego algorytmu.

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=10cm]{./adaptive_algo.png}
		\caption{Algorytm adaptacyjnego doboru liczby cząstek. Obrazek zaczerpnięto z\cite{adaptive} - TODO DODAĆ (8):y-h}
		%\label{bayes_fil_idea}
	\end{center}
\end{figure}

W skrócie, algorytm polega na sprawdzaniu, które cząstki leżą zbyt blisko siebie, a następnie ich stopniowemu usuwaniu, badając jak to wpływa na jakość jakość estymacji. Na koniec o nową liczbę cząstek określa się tak, aby pogorszenie estymacji nie było większe niż pewien próg.

\subsection{Box Particle Filter}
W tym podejściu zaproponowanym w \cite{bpfln}TODO i udoskonalonym w \cite{brbpf} zmieniono sposób reprezentacji cząstek, ponieważ zamiast punktów w przestrzeni stanów zastosowano interwały. Może się wydawać, iż zwiększy to złożoność obliczeniową, ponieważ trzeba o wiele więcej czasu poświęcić na analizę poszczególnych cząstek, jednak dzięki temu możemy zredukować samą ich liczbę.

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=10cm]{./bpf_algo.png}
		\caption{Algorytm Box Particle Filter}
		%\label{bayes_fil_idea}
	\end{center}
\end{figure}

Powyższy algorytm nie posiada wszystkich usprawnień zaproponowanych w \cite{brbpf}. Wykorzystano jedynie reinicjalizację, gdy wszystkie wagi się wyzerują.

\subsection{Wprowadzenie operatora mutacji}
W \cite{pfgen} zaproponowano, aby wzbogacić proces próbkowania o operatory krzyżowania i mutacji.

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=10cm]{./genetic_pf.png}
		\caption{Genetyczny filtr cząsteczkowy. Obrazek zaczerpnięto z \cite{pfgen}.}
		%\label{bayes_fil_idea}
	\end{center}
\end{figure}

%\subsection{Najczęstsze zastosowania}
%\cite{appl3} \cite{applg}
%\subsection{Przegląd aktualnych usprawnień} \label{przeg}
%\section{Filtry cząsteczkowe} \label{przeg}
\section{Wybrane narzędzia programistyczne}
\section{Badania} \label{przeg}
Będę badać wpływ kolejnych usprawnień znalezionych w literaturze, obrazki + tabelki.
\subsection{Badania poprawności działania}
Sprawdzenie czy spełnione sa warunki brzegowe
\subsubsection{Wpływ generatora}
mam nadzieję, że będzie tak samo XD
\subsubsection{Brak pkt odniesienia}
wiele równoważnych położeń
\subsubsection{Brak ewolucji systemu}
Powinny się pojawić izolinie.
\subsubsection{Pomiary bez związku}
powinien pozostać jednostajny szum

\subsection{Wpływ sposobu estymowania położenia}
\subsection{Wpływ funkcji określającej błąd pomiaru}
\subsection{Wpływ liczby cząstek}
\subsection{Wpływ metody próbkowania}
\subsection{Skuteczność w poprawianiu błędnie określonego położenia}
\subsection{Wpływ szumu}
\subsection{Wpływ różnorodności terenu}
\subsection{Rozkład p przy dryfie - chodzi o genetyczne}

\section{Wnioski}
\begin{itemize}
	\item 
\end{itemize}
\section{Podsumawanie}
co w kolejnych rozdziałach

\subsection{Kierunki przyszłych badań}
\begin{itemize}
	\item Zrezygnowanie z implementacji C++ na rzecz całkowitego przejścia na Python, z wykorzystaniem na przykład pakietu Numba \cite{numba}. Poza przyspieszeniem porównywalnym z C++, pozwoliło by na przykład na poszerzanie kodu o obliczenia na karcie graficznej. Dzięki temu, można by spróbować rozwiązać problem robota w pokoju, wykorzystując Box Particle Filter.
	\item zamiast avg, np klasteryzacja?
\end{itemize}

\bibliographystyle{unsrt}
\bibliography{biblio}

\end{document}